<!DOCTYPE html>
<html lang="en">
<head>
  <title>XYZ Explorer</title>
  <meta property="og:description" content="XYZ Explorer." />
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.js'></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #layer-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1;
      font-family: sans-serif;
      font-size: 14px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    </style>
</head>

<body>
  <div id="layer-controls" style="position:absolute; top:10px; left:10px; background:white; padding:10px; z-index:1;">
    <strong>View Mode:</strong><br>
    <label><input type="radio" name="layer-toggle" value="hexbins"> Hexbins</label><br>
    <label><input type="radio" name="layer-toggle" value="quadbins"> Quadbins</label><br>
    <label><input type="radio" name="layer-toggle" value="centroids"> Centroids</label>
  </div>

  <div id="map"></div>
  <script>
    let spaceID = 'stXc82l8';
    let hubApi = 'api.think-with-me.com';
    let clustering, rez;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('space')) spaceID = urlParams.get('space');
    if (urlParams.get('hubApi')) hubApi = urlParams.get('hubApi');

    let xyz_url = `https://${hubApi}/hub/spaces/${spaceID}/tile/web/{z}_{x}_{y}.mvt?clip=true`;

    // var not const so we can change it later
    var clustering_quadbin = '&clustering=quadbin&clustering.countmode=mixed&clustering.relativeResolution=4';
    var clustering_hexbin = '&clustering=hexbin';
    var clustering_centroid = '&clustering=hexbin&clustering.pointmode=true';
      
    if (urlParams.get('clustering')) {
      clustering = urlParams.get('clustering');
      let clustering_param = '';
      if (clustering === 'quadbin') clustering_param = clustering_quadbin;
      if (clustering === 'h3') clustering_param = clustering_hexbin;
      if (clustering === 'h3_centroid') clustering_param = clustering_centroid;
      xyz_url += clustering_param;

      if (urlParams.get('rez')) {
        rez = urlParams.get('rez');
        xyz_url += '&clustering.relativeResolution=' + rez;
      }
    }

    const styleUrl = 'https://api.protomaps.com/styles/v5/white/en.json?key=ffc24a4325d458ce';
    const map = new maplibregl.Map({
      container: 'map',
      hash: true,
      style: styleUrl,
      zoom: 13,
      center: [-122.447303, 37.753574]
    });

    const get_nested_number = [
      "to-number", [
        "slice",
        ["get", "aggregation"],
        ["+", ["index-of", ":", ["get", "aggregation"]], 2],
        ["-", ["length", ["get", "aggregation"]], 1]
      ]
    ];
      
    //   [
    //   "to-number", [
    //     "let", "o", ["get", "aggregation"],
    //     "let", "i", ["index-of", ":", ["var", "o"]],
    //     ["case",
    //       [">", ["var", "i"], -1],
    //       ["slice", ["var", "o"], ["+", ["var", "i"], 2], ["-", ["length", ["var", "o"]], 1]],
    //       "0"
    //     ]
    //   ]
    // ];

    const hexbin_clamped_log_nested_aggregation = [
      "case",
      ["<", ["index-of", ":", ["coalesce", ["get", "aggregation"], ""]], 0], 0,
      ["<", ["log2", ["to-number", ["slice", ["get", "aggregation"], ["+", ["index-of", ":", ["get", "aggregation"]], 2], ["-", ["length", ["get", "aggregation"]], 1]]]], 0], 0,
      [">", ["log2", ["to-number", ["slice", ["get", "aggregation"], ["+", ["index-of", ":", ["get", "aggregation"]], 2], ["-", ["length", ["get", "aggregation"]], 1]]]], 20], 20,
      ["log2", ["to-number", ["slice", ["get", "aggregation"], ["+", ["index-of", ":", ["get", "aggregation"]], 2], ["-", ["length", ["get", "aggregation"]], 1]]]]
    ];

    const clamped_log_count = [
      "case",
      ["<", ["log2", ["coalesce", ["get", "count"], 1]], 0], 0,
      [">", ["log2", ["coalesce", ["get", "count"], 1]], 20], 20,
      ["log2", ["coalesce", ["get", "count"], 1]]
    ];

    const red_log_clamped_hexbin_ramp = [
      "interpolate", ["linear"],
      hexbin_clamped_log_nested_aggregation,
      0, "#fee5d9",
      6, "#fcae91",
      12, "#fb6a4a",
      16, "#de2d26",
      20, "#a50f15"
    ];

    const red_log_quadbin_ramp = [
      "interpolate", ["linear"],
      clamped_log_count,
      0, "#fee5d9",
      6, "#fcae91",
      12, "#fb6a4a",
      16, "#de2d26",
      20, "#a50f15"
    ];

    const xyzLayers = {
      hexbins: {
        id: 'hexbins',
        type: 'fill',
        source: 'xyz',
        'source-layer': spaceID,
        paint: {
          'fill-color': red_log_clamped_hexbin_ramp,
          'fill-opacity': 0.3
        },
        filter: [
          "all",
          ["==", "$type", "Polygon"],
          ["==", "kind", "h3"]
        ]
      },
      quadbins: {
        id: 'quadbins',
        type: 'fill',
        source: 'xyz',
        'source-layer': spaceID,
        paint: {
          'fill-color': red_log_quadbin_ramp,
          'fill-opacity': 0.3
        },
        filter: [
          "all",
          ["==", "$type", "Polygon"],
          ["has", "qk"]
        ]
      },
      centroids: {
        id: 'centroids',
        type: 'circle',
        source: 'xyz',
        'source-layer': spaceID,
        paint: {
          'circle-radius': ["+", 6, ["log2", get_nested_number]],
          'circle-color': red_log_clamped_hexbin_ramp,
          'circle-opacity': 0.2,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#000000',
          'circle-stroke-opacity': 0.5
        },
        filter: [
          "all",
          ["==", "$type", "Point"],
          ["==", "kind", "h3"]
        ]
      },
      labels: {
        id: 'bin-labels',
        type: 'symbol',
        source: 'xyz',
        'source-layer': spaceID,
        layout: {
          "text-ignore-placement": true,
          "symbol-placement": "point",
          "text-field": ["coalesce", ["to-string", ["get", "count"]], ["to-string", get_nested_number]],
          "text-size": 10,
          "text-justify": "center",
          "text-font": ["Noto Sans Regular"],
          "text-variable-anchor": ["center", "top", "bottom", "left", "right"]
        },
        paint: {
          "text-color": "#000",
          "text-halo-color": "#fff",
          "text-halo-width": 1.5
        },
        filter: [
          "any",
          ["==", "kind", "h3"],
          ["has", "qk"]
        ]
      },
      outlines: {
        id: 'outlines',
        type: 'line',
        source: 'xyz',
        'source-layer': spaceID,
        paint: {
          'line-color': '#cccccc',
          'line-width': 1
        },
        filter: ['==', '$type', 'Polygon']
      }
    };

    map.on('load', () => {
      const layers = map.getStyle().layers;
      let firstSymbolId;
      for (let i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol') {
          firstSymbolId = layers[i].id;
          break;
        }
      }

      map.addSource('xyz', {
        type: 'vector',
        tiles: [xyz_url]
      });

      map.addLayer(xyzLayers.hexbins);
      map.addLayer(xyzLayers.labels);

      // Object.values(xyzLayers).forEach(layer => {
      //   map.addLayer(layer, firstSymbolId);
      //   map.setLayoutProperty(layer.id, 'visibility', 'none');
      // });

      document.querySelectorAll('input[name="layer-toggle"]').forEach(input => {
        input.addEventListener('change', event => {
          const selectedLayer = event.target.value;
          toggleToLayer(selectedLayer);
          reloadLayer(selectedLayer);
        });
      });

      // toggleToLayer('hexbins');
    });

    function toggleToLayer(selectedId) {
      Object.values(xyzLayers).forEach(layer => {
        if (map.getLayer(layer.id)) {
          map.setLayoutProperty(layer.id, 'visibility', 'none');
        }
      });

      if (map.getLayer(xyzLayers.outlines.id)) {
        map.setLayoutProperty(xyzLayers.outlines.id, 'visibility', 'visible');
      }

      const mainLayer = xyzLayers[selectedId];
      if (mainLayer) {
        map.setLayoutProperty(mainLayer.id, 'visibility', 'visible');
      }

      if (map.getLayer(xyzLayers.labels.id)) {
        map.setLayoutProperty(xyzLayers.labels.id, 'visibility', 'visible');
      }
    }

    function reloadLayer(layerId) {
      const layer = xyzLayers[layerId];
      if (!layer) return;

      if (map.getLayer(layer.id)) {
        map.removeLayer(layer.id);
      }
      map.addLayer(layer);
    }
  </script>
</body>
</html>
